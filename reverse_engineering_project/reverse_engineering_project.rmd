---
title: "Reverse Engineering Project"
author: "Raphael Romero Ruiz & Sophia Hernadez-Pi√±a"
date: "`Oct. 9 2025`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

13-23: Here we installed a package called tidycensus with enabled us to more easily use and work with data from the U.S. Census Bureau. We used this to pull information about the murder rates v. how many murders have been solved during certain time frames. We also installed the census_api_key, which holds the original data we will be using.
```{r}
install.packages("tidycensus")
```
```{r}
library(tidyverse)
library(janitor)
library(lubridate)
library(dplyr)
library(tidycensus)
library(readxl)

census_api_key("a053b1e13b17cfecd7fea96af2fc15059d046f8c", install=TRUE)
```
27-28: This code reads a CSV file that hold homicide data and then simplified the column names into a consistent, lowercase format, which made it easier for us to work with the data. 
```{r}
homicides_wapo <- read_csv("data-homicides/homicide-data.csv") %>% 
  clean_names()
```
33-39: This code fixes two issues in the reported dates and then converted all the data from the numbers into a proper date formation that R can understand. The mutate() function corrects two data entry errors, changing "201511105" to "20151105" and "201511018" to "20151118," while leaving all other dates the same, then we used the ymd() function to transform the numbers into a year-month-day format into actual date object that can be used for time-based analysis.
```{r}
# First make sure reported_date is in proper date format
homicides_wapo <- homicides_wapo %>%
  mutate(reported_date = case_when(
    reported_date == 201511105 ~ 20151105,
    reported_date == 201511018 ~ 20151118, 
    TRUE ~ reported_date
  )) %>%
  mutate(reported_date = ymd(reported_date))
```

47-60: This code imports historical Census population data for Baltimore city from a file, cleaning it up and reshaping it into a simple two-column format that shows the year and the population. The code standardizes the column names, filters to keep only the information from Baltimore city, and then extracts data from 2007, 2008 and 2009 populations. This made it easier to combine with other datasets.

```{r}
# Get population estimates for Baltimore City (2007-2014)
# First get 2007-2009 from XLS file
census_pop_2007_2009 <- read_xls("census-data/co-est00int-01-24.xls") %>%
  slice((6):(n() - 8)) %>%
  clean_names() %>%
  filter(str_detect(table_with_row_headers_in_column_a_and_column_headers_in_rows_3_through_4_leading_dots_indicate_sub_parts, "Baltimore city")) %>%
  transmute(
    pop_2007 = as.numeric(x10),
    pop_2008 = as.numeric(x11), 
    pop_2009 = as.numeric(x12)
  ) %>%
  pivot_longer(cols = everything(),
               names_to = "year_col", 
               values_to = "population") %>%
  mutate(year = as.numeric(str_extract(year_col, "[0-9]{4}"))) %>%
  select(year, population)
```
65-92: This uses the tidycensus package to download population estimates for Baltimore city from 2010 through 2014 directly from the U.S. Census' API. The get_estimates() function retrives the time-based population data using Baltimore's FIPS code (510), the the code translates the Census Bureau's numeric date codes into actual years, keeping only the estimates from 2010 to 2014, and creates a two-column dataset with year and population that matches the format of the earlier data.
```{r}
# Then get 2010-2014 from Census API
census_pop_2010_2014 <- get_estimates(
    geography = "county",
    vintage = 2019,
    time_series = TRUE,
    state = "MD",
    county = "510",  # Baltimore City FIPS code
    variable = "POP"
  ) %>%
  # The date column uses Census codes based on official documentation
  mutate(year = case_when(
    DATE == 1 ~ 2010,  # April 1, 2010 Census count
    DATE == 2 ~ NA,  # April 1, 2010 estimates base (not used)
    DATE == 3 ~ NA,  # July 1, 2010 estimate (not used)
    DATE == 4 ~ 2011,  # July 1, 2011 estimate
    DATE == 5 ~ 2012,  # July 1, 2012 estimate
    DATE == 6 ~ 2013,  # July 1, 2013 estimate
    DATE == 7 ~ 2014,  # July 1, 2014 estimate
    DATE == 8 ~ 2015,  # July 1, 2015 estimate
    DATE == 9 ~ 2016,  # July 1, 2016 estimate
    DATE == 10 ~ 2017, # July 1, 2017 estimate
    DATE == 11 ~ 2018, # July 1, 2018 estimate
    DATE == 12 ~ 2019, # July 1, 2019 estimate
    TRUE ~ as.numeric(DATE)
  )) %>%
  select(year, value) %>%
  rename(population = value) %>%
  filter(year >= 2010 & year <= 2014) %>%
  arrange(year)
```
97-101: This combines the two serparate population datasets, one covering 2007 to 2009 and the other covering 2010 to 2014, into a single dataset that sorts it chronologically by year. The bind_rows() function stacks the two datasets on top of each other snce they share the same column structure. arrange() makes sure all the years appear in order from earliest to latest, creating one continuous population series for Baltimore city from 2007 to 2014.
```{r}
# Combine 2007-2009 Excel data with 2010-2014 Census API data
pop_estimates_pre_2015 <- bind_rows(
  census_pop_2007_2009,
  census_pop_2010_2014
) %>%
  arrange(year)
```

106-135:This downloads population estimates for Baltimore city from 2015 to 2017 using the same Census API. It coverts the data into a clean format in chronological order. The process is similar to the previous download but filters the data to only keep the years 2015 through 2017, translating the Census' numeric date codes into readable years and organizes the data into two-column datasets. The dataset shows the year and population that can be joined with the pre-2015 data.

```{r}
# Get population estimates for Baltimore City (post-2015)
pop_estimates_post_2015 <- get_estimates(
    geography = "county",
    vintage = 2019,
    time_series = TRUE,
    state = "MD",
    county = "510",  # Baltimore City FIPS code
    variable = "POP"
  ) %>%
  # The date column uses Census codes based on official documentation
  mutate(year = case_when(
    DATE == 1 ~ 2010,  # April 1, 2010 Census count
    DATE == 2 ~ 2010,  # April 1, 2010 estimates base
    DATE == 3 ~ 2010,  # July 1, 2010 estimate
    DATE == 4 ~ 2011,  # July 1, 2011 estimate
    DATE == 5 ~ 2012,  # July 1, 2012 estimate
    DATE == 6 ~ 2013,  # July 1, 2013 estimate
    DATE == 7 ~ 2014,  # July 1, 2014 estimate
    DATE == 8 ~ 2015,  # July 1, 2015 estimate
    DATE == 9 ~ 2016,  # July 1, 2016 estimate
    DATE == 10 ~ 2017, # July 1, 2017 estimate
    DATE == 11 ~ 2018, # July 1, 2018 estimate
    DATE == 12 ~ 2019, # July 1, 2019 estimate
    TRUE ~ as.numeric(DATE)
  )) %>%
  select(year, value) %>%
  rename(population = value) %>%
  filter(year >= 2015 & year <= 2017) %>%
  arrange(year)
```

142-151: This analyzes baltimore homicide data before 2015, calculating the total number of homicides, arrests and the arrest rate for each year. The code filters the Washington Post homicide dataset to include only Baltimore cases before Jan 1, 2015, extracting the year from each homicide's reported date and then groups the data by year to count the total homicides. It then tallies how many cases resulted in arrests and calculate the percentage of homicides that led to arrests, rounding the arrest rate and presenting the data in chronological order.

```{r}
# Get Baltimore homicides and arrests by year before 2015
num_hom_and_arrest_bmore_by_year_pre_2015 <- homicides_wapo %>%
  filter(city == "Baltimore" & reported_date < "2015-01-01") %>%
  mutate(year = year(reported_date)) %>%
  group_by(year) %>%
  summarise(
    homicides = n(),
    arrests = sum(disposition == "Closed by arrest"),
    arrest_rate = round((sum(disposition == "Closed by arrest") / n()) * 100, 1)
  ) %>%
  arrange(year)  # Sort by year
```

158-167: This shows the same homicide and arrest analysis as the previous code but focuses specifically on Baltimore cases from 2015 through 2017, the period after Freddie Gray's death and the turmoil that followed. The code filters the Washington Post data to include only Baltimore homicides that occured between jan. 1, 2015 and Dec. 31, 2017. It then calculates the annual totals for homicides and arrests along with the arrest rate for each year, letting us compare how policing patterns may have changed during this timeframe. 

```{r}
# Get Baltimore homicides and arrests for 2015-2017
num_hom_and_arrests_bmore_by_year_post_2015 <- homicides_wapo %>%
  filter(city == "Baltimore" & reported_date >= "2015-01-01" & reported_date <= "2017-12-31") %>%
  mutate(year = year(reported_date)) %>%
  group_by(year) %>%
  summarise(
    homicides = n(),
    arrests = sum(disposition == "Closed by arrest"),
    arrest_rate = round((sum(disposition == "Closed by arrest") / n()) * 100, 1)
  ) %>%
  arrange(year)
```

174-176: This code combines the pre-2015 Baltimore homicide statisitics with population data to calculate the homicide rater ber 100,000 residents for each year. The lef_join() function merges the homicde and arrest counts with the corresponding population estimates by matching years. Then, the code calculates the standardized homicide rate by dividing the number of homicides by the populatio and multiplying by 100,000, rounding the results.

```{r}
# Calculate pre-2015 rates
bmore_hom_rates_pre_2015 <- num_hom_and_arrest_bmore_by_year_pre_2015 %>%
  left_join(pop_estimates_pre_2015, by = "year") %>%
  mutate(homicide_rate_per_100k = round((homicides / population) * 100000, 1))
```

183-185: This merges the 2015-2017 Baltimore homicide statistics with population data to calculate the homicide rate per 100,000 resident for those post-Freddie Gray years. Using the same methods for the pre-2015 analysis, the code joins the homicide and arrest counts with the corresponding population estimates by year. It then standardizes the homicide rate, divinding homicides by population and multiplying by 100,000, to create a rate that accounts for population changes that can be directly compared with the earlier years to asses whether violence in baltimore city has increased after 2015. 

```{r}
# Calculate post-2015 rates
bmore_hom_rates_post_2015 <- num_hom_and_arrests_bmore_by_year_post_2015 %>%
  left_join(pop_estimates_post_2015, by = "year") %>%
  mutate(homicide_rate_per_100k = round((homicides / population) * 100000, 1))
```

```{r}
# Combine all years into one comparison
bmore_rates_all_years <- bind_rows(
  bmore_hom_rates_pre_2015,
  bmore_hom_rates_post_2015
) %>%
  arrange(year)
```

```{r}
#everything below here is for assignment 3 and beyond
```


```{r}
# CHICAGO ANALYSIS
# Get population estimates for Chicago (2015-2017)
pop_estimates_chicago_post_2015 <- get_estimates(
    geography = "place",
    vintage = 2019,
    time_series = TRUE,
    state = "IL",
    place = 1400,
    variable = "POP"
  ) %>%
  filter(str_detect(NAME, "^Chicago city, Illinois$")) %>%
  mutate(year = case_when(
    DATE == 1 ~ 2010,
    DATE == 2 ~ 2010,
    DATE == 3 ~ 2010,
    DATE == 4 ~ 2011,
    DATE == 5 ~ 2012,
    DATE == 6 ~ 2013,
    DATE == 7 ~ 2014,
    DATE == 8 ~ 2015,
    DATE == 9 ~ 2016,
    DATE == 10 ~ 2017,
    DATE == 11 ~ 2018,
    DATE == 12 ~ 2019,
    TRUE ~ as.numeric(DATE)
  )) %>%
  select(year, value) %>%
  rename(population = value) %>%
  filter(year >= 2015 & year <= 2017) %>%
  arrange(year)
```
```{r}
# Get Chicago homicides for 2015-2017
num_hom_and_arrests_chicago_by_year_post_2015 <- homicides_wapo %>%
  filter(city == "Chicago" & reported_date >= "2015-01-01" & reported_date <= "2017-12-31") %>%
  mutate(year = year(reported_date)) %>%
  group_by(year) %>%
  summarise(
    homicides = n(),
    arrests = sum(disposition == "Closed by arrest"),
    arrest_rate = round((sum(disposition == "Closed by arrest") / n()) * 100, 1)
  ) %>%
  arrange(year)
```

```{r}
# Calculate post-2015 rates
chi_hom_rates_post_2015 <- num_hom_and_arrests_chicago_by_year_post_2015 %>%
  left_join(pop_estimates_chicago_post_2015, by = "year") %>%
  mutate(homicide_rate_per_100k = round((homicides / population) * 100000, 1))
```

```{r}
# BOSTON ANALYSIS
# Get Boston homicides and arrests by year (pre-2015)
num_hom_and_arrest_boston_by_year_pre_2015 <- homicides_wapo %>%
  filter(city == "Boston" & reported_date < "2015-01-01") %>%
  mutate(year = year(reported_date)) %>%
  group_by(year) %>%
  summarise(
    homicides = n(),
    arrests = sum(disposition == "Closed by arrest"),
    arrest_rate = round((sum(disposition == "Closed by arrest") / n()) * 100, 1)
  ) %>%
  arrange(year)
```
```{r}
# Get population estimates for Boston (2015-2017)
pop_estimates_boston_post_2015 <- get_estimates(
    geography = "place",
    vintage = 2019,
    time_series = TRUE,
    state = "MA",
    place = "07000",  # Boston place code
    variable = "POP"
  ) %>%
  mutate(year = case_when(
    DATE == 1 ~ 2010,
    DATE == 2 ~ 2010,
    DATE == 3 ~ 2010,
    DATE == 4 ~ 2011,
    DATE == 5 ~ 2012,
    DATE == 6 ~ 2013,
    DATE == 7 ~ 2014,
    DATE == 8 ~ 2015,
    DATE == 9 ~ 2016,
    DATE == 10 ~ 2017,
    DATE == 11 ~ 2018,
    DATE == 12 ~ 2019,
    TRUE ~ as.numeric(DATE)
  )) %>%
  #filter(str_detect(NAME, "^Boston, Massachusetts$")) %>% 
  select(year, value) %>%
  rename(population = value) %>%
  filter(year >= 2015 & year <= 2017) %>%
  arrange(year)
```
```{r}
# Get Boston homicides (2015-2017)
num_hom_and_arrests_boston_by_year_post_2015 <- homicides_wapo %>%
  filter(city == "Boston" & reported_date >= "2015-01-01" & reported_date <= "2017-12-31") %>%
  mutate(year = year(reported_date)) %>%
  group_by(year) %>%
  summarise(
    homicides = n(),
    arrests = sum(disposition == "Closed by arrest"),
    arrest_rate = round((sum(disposition == "Closed by arrest") / n()) * 100, 1)
  ) %>%
  arrange(year)
```

```{r}
# ST. LOUIS ANALYSIS
# Get St. Louis homicides and arrests by year before 2015
num_hom_and_arrest_stl_by_year_pre_2015 <- homicides_wapo %>%
  filter(city == "St. Louis" & reported_date < "2015-01-01") %>%
  mutate(year = year(reported_date)) %>%
  group_by(year) %>%
  summarise(
    homicides = n(),
    arrests = sum(disposition == "Closed by arrest"),
    arrest_rate = round((sum(disposition == "Closed by arrest") / n()) * 100, 1)
  ) %>%
  arrange(year)
```

```{r}
# Get population estimates for St. Louis
pop_estimates_stl_post_2015 <- get_estimates(
    geography = "place",
    vintage = 2019,
    time_series = TRUE,
    state = "MO",
    place = "65000",  # St. Louis place code
    variable = "POP"
  ) %>%
  mutate(year = case_when(
    DATE == 1 ~ 2010,
    DATE == 2 ~ 2010,
    DATE == 3 ~ 2010,
    DATE == 4 ~ 2011,
    DATE == 5 ~ 2012,
    DATE == 6 ~ 2013,
    DATE == 7 ~ 2014,
    DATE == 8 ~ 2015,
    DATE == 9 ~ 2016,
    DATE == 10 ~ 2017,
    DATE == 11 ~ 2018,
    DATE == 12 ~ 2019,
    TRUE ~ as.numeric(DATE)
  )) %>%
  #filter(str_detect(NAME, "^St. Louis, Missouri$")) %>%
  select(year, value) %>%
  rename(population = value) %>%
  filter(year >= 2015 & year <= 2017) %>%
  arrange(year)
```

```{r}
# Get St. Louis homicides for 2015-2017
num_hom_and_arrests_stl_by_year_post_2015 <- homicides_wapo %>%
  filter(city == "St. Louis" & reported_date >= "2015-01-01" & reported_date <= "2017-12-31") %>%
  mutate(year = year(reported_date)) %>%
  group_by(year) %>%
  summarise(
    homicides = n(),
    arrests = sum(disposition == "Closed by arrest"),
    arrest_rate = round((sum(disposition == "Closed by arrest") / n()) * 100, 1)
  ) %>%
  arrange(year)

# Use census estimates for St. Louis populations
populations_stl_post_2015 <- pop_estimates_stl_post_2015
```
